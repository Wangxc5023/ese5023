<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Section 10 Python environments and parallel computing with dask</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 66px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h2 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h3 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h4 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h5 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h6 {
  padding-top: 71px;
  margin-top: -71px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Computing and Programming for Environmental Research</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="Syllabus.html">
    <span class="fa fa-bell-o"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="Schedule.html">
    <span class="fa fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li>
  <a href="Resource.html">
    <span class="fa fa-wrench"></span>
     
    Resource
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Assignment_01.html">Assignment 01</a>
    </li>
    <li>
      <a href="Assignment_02.html">Assignment 02</a>
    </li>
    <li>
      <a href="Assignment_03.html">Assignment 03</a>
    </li>
    <li>
      <a href="Assignment_04.html">Assignment 04</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Section 10 Python environments and parallel computing with <code>dask</code></h1>

</div>


<blockquote>
<p>“Your code is the product of your environment.” - Robert Sandor</p>
</blockquote>
<hr />
<div id="prerequisites" class="section level1">
<h1>Prerequisites</h1>
<p>In this section, we will use daily data from the <a href="https://www.aviso.altimetry.fr/en/home.html">AVISO</a> sea-surface height satellite altimetry dataset. Download the file (<code>aviso_2015.zip</code>, ~ <code>390 MB</code>) <a href="">from here</a>, unzip it, you will have a folder (<code>aviso_2015</code>) containing <code>365</code> nc files. Move the folder to your working directory.</p>
<hr />
</div>
<div id="python-environments" class="section level1">
<h1><code>Python</code> environments</h1>
<p><code>Python</code> and nearly all of the software packages in the scientific <code>Python</code> ecosystem are <strong>open-source</strong>. They are maintained and developed by a community of scientists and programmers, some of whose work is supported by universities, non-profits, and for-profit corporations. Because there is no single authority that controls all of these packages, coordinating the compatibility between these different packages and their multiple versions used to be a nightmare.</p>
<p>Sometimes when we create software, the software needs to run on a <strong>specific version</strong> of <code>Python</code> because our software expects a certain behavior that is present in older versions but changes in newer versions. Likewise, we may need to use specific versions of the libraries for similar reasons. But we may have many projects on our computer, perhaps a project that runs on with <code>xarray</code> version 0.1 and <code>Python 2.7</code> and even a more modern project that runs on <code>xarray</code> version 0.8 and <code>Python 3.8</code>. If we try running both at once on <code>Python 2.7</code> or <code>Python 3.8</code>, one of them may break because some of the code that runs on <code>Python 2</code> doesn’t run on <code>Python 3</code> or vice versa. This is where virtual <strong>environments</strong> become useful.</p>
<p>Virtual environments keep these dependencies in separate “sandboxes” so you can switch between both applications easily and get them running. <code>Python</code> environments take care of most of the dependencies and modules for us, but we will have to get our hands dirty in <code>Python</code> and deal with the environments.</p>
<p>In this section, we will learn how to use <code>conda</code> to manage a <code>Python</code> environment (“sandbox”) we play in.</p>
<p><img src="figs/sandbox.png" alt="drawing" width="600"/></p>
<p><a href="https://miro.medium.com/max/544/1*IwZIB3XSOyfAf3DXK5jmEA.png">Figure source</a></p>
<div id="creating-a-python-environment" class="section level2">
<h2>Creating a <code>Python</code> environment</h2>
<p><code>Python</code> coupled with a package manager provides a way to make isolated, reproducible environments where you have fine-tuned control overall packages and configuration. From now on, you are highly recommended to work within an environment, rather than the “default” environment.</p>
<p>To see all the environments on your system, type the following in <code>Anaconda Powershell Prompt</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">conda</span> info --envs</span></code></pre></div>
<p>This command should display the current environments, with <code>*</code> marking the environment you are in.</p>
<p>To quickly create an environment (called <code>cper</code>, standing for <em>Computing and Programming for Environmental Research</em>) using <code>conda</code>, type the following in <code>Anaconda Powershell Prompt</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">conda</span> create --name cper python=3.8.8</span></code></pre></div>
<p>In this command, the <code>python=3.8.8</code> portion specifies which version of <code>Python</code> you want to set up the environment in; you can change the version to whatever suits your needs. Here <code>--name</code> sets the name of the environment. In other snippets you see online, you may see <code>--n</code> instead of <code>--name</code>; they mean exactly the same thing.</p>
<p>Now display the current environments with <code>conda info --envs</code>, you will something like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">base</span>                   * C:\Users\86133\anaconda3</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">cper</span>                     C:\Users\86133\anaconda3\envs\cper</span></code></pre></div>
</div>
<div id="using-a-python-environment" class="section level2">
<h2>Using a <code>Python</code> environment</h2>
<p>After confirming that you created the environment, let’s now actually use it. We can accomplish this by typing:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">conda</span> activate cper</span></code></pre></div>
<p>At this point, your terminal prompt should look something like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">(</span><span class="ex">cper</span><span class="kw">)</span> <span class="ex">PS</span> C:\Users\<span class="op">86133&gt;</span></span></code></pre></div>
<p>Now display the current environments with <code>conda info --envs</code>, you will something like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">base</span>                     C:\Users\86133\anaconda3</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ex">cper</span>                   * C:\Users\86133\anaconda3\envs\cper</span></code></pre></div>
<p>The <code>*</code> indicates that we are in the <code>cper</code> environment.</p>
<p>To get a complete summary of all the packages installed in an environment, the channel they were installed from, and their full version info, type:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">conda</span> list</span></code></pre></div>
<p>To stop using the <code>cper</code> environment, type in:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">conda</span> deactivate cper</span></code></pre></div>
<p>If you would like to get rid of the entire <code>cper</code> environment, type in:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">conda</span> remove --name cper --all</span></code></pre></div>
<p>The <code>--all</code> flag is to remove all packages from the environment and is necessary to completely clean the environment.</p>
<p>For extensive documentation on using environments, please see the <a href="https://conda.io/projects/conda/en/latest/user-guide/concepts/environments.html">conda documentation</a>.</p>
</div>
<div id="installing-modules-under-a-python-environment" class="section level2">
<h2>Installing modules under a <code>Python</code> environment</h2>
<p>Once you have a basic <code>Python</code> environment, you can easily add or remove modules using the <code>conda</code> command-line utility. <code>Conda</code> was created to help manage the complex dependencies and pre-compiled binary libraries that are necessary in scientific python. If you set up your python environment using the <code>Anaconda</code> Python Distribution or with <code>miniconda</code>, you should already have the <code>conda</code> command available on the command line. With it, you can easily install modules from an official, curated set of packages which are built and tested for a number of different system configurations on Linux, Windows, and macOS.</p>
<p>To install a module (say <code>XXXX</code>), first activate the environment (say <code>cper</code>) under which you would like to install it:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">conda</span> activate cper</span></code></pre></div>
<p>Then type:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">conda</span> install XXXX</span></code></pre></div>
<p>Additionally, there is a community-maintained collection of packages/recipes called <a href="https://conda-forge.org/">conda forge</a> which is accessible through <code>conda</code> as a special “channel”:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">conda</span> install -c conda-forge XXXX</span></code></pre></div>
<p>While <code>conda</code> allows you to install almost any science-related package, there may be other general-use python packages you wish to you that are not available via <code>conda</code>. For these, you can use an alternative installation method.</p>
<p>Outside of the scientific python community, the most common way to install packages is to search for them on the <a href="https://pypi.org/">official <code>PyPI</code> index</a>. Once you’ve found the package you want to install (you may have also just found it on Github or elsewhere), you use the <code>pip</code> command from the command line:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">pip</span> install XXXX</span></code></pre></div>
<p>If you can’t find a package on either <code>PyPI</code> or <code>conda-forge</code>, you can always install it directly from the source code. If the package is on <code>github</code>, <code>pip</code> already has an alias to do this for you:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="ex">pip</span> install git+https://github.com/.../XXXX.git</span></code></pre></div>
<p>Where <code>https://github.com/.../XXXX.git</code> indicates the url of the module.</p>
<p>Now let’s install some modules under the <code>cper</code> environment. Make sure you have activated the <code>cper</code> environment; otherwise, modules will be installed under the <code>base</code> environment.</p>
<p>First, we will install modules via <code>conda</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">conda</span> install numpy pandas matplotlib netCDF4 xarray notebook cartopy dask python-graphviz</span></code></pre></div>
<p>Later, we use <code>pip</code> to install a module via a different channel:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a><span class="ex">pip</span> install nc-time-axis</span></code></pre></div>
<p>Now use <code>conda list</code> to verify that we have successfully installed the above modules.</p>
</div>
<div id="using-the-environment-file" class="section level2">
<h2>Using the environment file</h2>
<p>As you type <code>conda list</code>, you get a complete summary of all the modules installed in your environment, the channel they were installed from, and their full version info. Using this info, you are able to create an environment file in <a href="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html"><code>YAML</code> syntax</a> (YAML Ain’t Markup Language) which documents the exact contents of your environment.</p>
<p>To export your current environment (<code>cper</code>) to a <code>yml</code> file (<code>my_environment.yml</code>):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="ex">conda</span> env export --name cper <span class="op">&gt;</span> my_environment.yml</span></code></pre></div>
<p>The <code>&gt;</code> indicates that the output is writing to a file called <code>my_environment.yml</code>. If there were any contents in <code>my_environment.yml</code> before this command, they would be overwritten. Now in your working directory, a file <code>my_environment.yml</code> was just created, open it, you will see a list of configurations of the <code>cper</code> environment.</p>
<p>The environment file (<code>my_environment.yml</code>) is very useful, as it allows creating an <strong>identical</strong> environment. You can use different environment files for different projects, or share an environment file with someone to grantee <strong>reproducible research</strong>.</p>
<p>To create a new environment (say <code>cper_new</code>) through existing environment file (say <code>ZZZZ.yml</code>), go to the folder that contains this environment file, type:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">conda</span> env create --name cper_new --file ZZZZ.yml</span></code></pre></div>
<hr />
</div>
</div>
<div id="dask-for-parallel-computing" class="section level1">
<h1><code>Dask</code> for parallel computing</h1>
<p>In past lectures, we learned how to use <code>numpy</code>, <code>pandas</code>, and <code>xarray</code> to analyze various types of data. In this section, we address an increasingly common problem: what happens if the data we wish to analyze is “big data”.</p>
<p>A good threshold for when data becomes difficult to deal with is when the volume of data exceeds your computer’s RAM (Random-access memory). Most modern laptops have between <code>2 GB</code> and <code>16 GB</code> of RAM. High-end workstations and servers can have <code>1 TB</code> or RAM or more. If the dataset you are trying to analyze can’t fit in your computer’s memory, some special care is required to carry out the analysis.</p>
<p>The next threshold of difficulty is when the data can’t fit on your hard drive. Most modern laptops have between <code>100 GB</code> and <code>4 TB</code> of storage space on the hard drive. If you can’t fit your dataset on your internal hard drive, you can buy an external hard drive. However, at that point you are better off using a high-end server, HPC system, or cloud-based storage for your dataset. Once you have many <code>TB</code> of data to analyze, you are definitely in the realm of “big data”.</p>
<div id="introduction-to-dask" class="section level2">
<h2>Introduction to <code>dask</code></h2>
<p><code>Dask</code> is a tool that helps us easily extend our familiar <code>Python</code> data analysis tools to medium and big data, i.e. dataset that can’t fit in our computer’s RAM. In many cases, <code>dask</code> also allows us to speed up our analysis by using multiple CPU cores. <code>Dask</code> can help us work more efficiently on our laptop, and it can also help us <strong>scale up</strong> our analysis on HPC and cloud platforms. Most importantly, <code>dask</code> is almost invisible to the user, meaning that you can focus on your science, rather than the details of parallel computing.</p>
<p><code>Dask</code> provides collections for big data and a scheduler for parallel computing. In this section, we will learn the basics of using <code>dask</code> through examples. For more about <code>dask</code>, check <a href="https://docs.dask.org/en/latest/">The Dask Documentation</a> and <a href="https://github.com/dask/dask">The Dask Github Site</a>. For other modules enabling parallel computing, check <a href="https://wiki.python.org/moin/ParallelProcessing">Parallel Processing and Multiprocessing in Python</a>.</p>
</div>
<div id="making-a-local-client" class="section level2">
<h2>Making a local client</h2>
<p><code>Dask</code> has several ways of executing code in parallel. We’ll use the <a href="http://distributed.dask.org/en/stable/">distributed scheduler</a> by creating a <code>dask.distributed.Client</code>. For now, this will provide us with some nice diagnostics.</p>
<p>Let’s make a local client (<code>my_client</code>) with <code>4</code> workers (<code>1</code> thread per worker):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Use the distributed scheduler to form a local client (cluster)</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># 4 works, 1 thread (CPU) per work</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>my_client <span class="op">=</span> Client(n_workers<span class="op">=</span><span class="dv">4</span>, threads_per_worker<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co"># Show information of the local client</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>my_client.cluster</span></code></pre></div>
<p>Click the the Dashboard link, get yourself familiarized with it.</p>
<p>If you no longer use a client, make sure to close your client or stop this kernel:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>my_client.close()</span></code></pre></div>
</div>
<div id="parallelizing-code-with-dask.delayed" class="section level2">
<h2>Parallelizing code with <code>dask.delayed()</code></h2>
<p>In this sub-section we parallelize some simple code with <code>dask</code> and <a href="https://docs.dask.org/en/latest/delayed.html"><code>dask.delayed</code></a>. Often, this is the only function that you will need to convert functions for use with <code>dask</code>. This is a simple way to use <code>dask</code> to parallelize existing codebases or build complex systems.</p>
<p>First let’s make some toy functions, <code>fun1</code> and <code>fun2</code>, that sleep for a while to simulate work. We’ll then time running these functions normally.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># Define two functions</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="kw">def</span> fun1(x):</span>
<span id="cb21-3"><a href="#cb21-3"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="kw">def</span> fun2(x, y):</span>
<span id="cb21-7"><a href="#cb21-7"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="cf">return</span> x <span class="op">+</span> y</span></code></pre></div>
<p>We then time the execution of this normal code using the <code>%%time</code> magic, which is a special function of the <code>Jupyter Notebook</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a><span class="op">%%</span>time</span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co"># This takes three seconds to run because we call each</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co"># function sequentially, one after the other</span></span>
<span id="cb22-5"><a href="#cb22-5"></a></span>
<span id="cb22-6"><a href="#cb22-6"></a>x <span class="op">=</span> fun1(<span class="dv">1</span>)</span>
<span id="cb22-7"><a href="#cb22-7"></a>y <span class="op">=</span> fun1(<span class="dv">2</span>)</span>
<span id="cb22-8"><a href="#cb22-8"></a>z <span class="op">=</span> fun2(x, y)</span></code></pre></div>
<p>Those two increment calls could be called in parallel, because they are totally <strong>independent of one-another</strong>.</p>
<p>We’ll transform the <code>fun1</code> and <code>fun2</code> functions using the <code>dask.delayed()</code> function. When we call the <strong>delayed version</strong> by passing the arguments, exactly as before, the original function <strong>isn’t</strong> actually called yet - which is why the cell execution finishes very quickly. <strong>Instead, a delayed object is made, which keeps track of the function to call and the arguments to pass to it.</strong></p>
<p>This ran immediately, since nothing has really happened yet. To get the result, call <code>compute</code>. Notice that this runs faster than the original code.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="op">%%</span>time</span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co"># This actually runs our computation using a local cluster</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>z.compute()</span></code></pre></div>
<p>Here, the <code>z</code> object is a <em>lazy</em> <code>Delayed</code> object, which holds everything we need to compute the final result, including references to all of the functions that are required and their inputs and relationship to one-another. We can evaluate the result with <code>.compute()</code> as above or we can visualize the task graph for this value with <code>.visualize()</code>. As you can see, such a lazy execution allows building up complex, large calculations symbolically before turning them over to the scheduler for execution. For more, check <a href="https://tutorial.dask.org/01x_lazy.html">Dask lazy execution</a>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># Look at the task graph for z</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>z.visualize()</span></code></pre></div>
<p>Notice that this includes the names of the functions from before, and the logical flow of the outputs of the <code>fun1</code> functions to the inputs of <code>fun2</code>.</p>
</div>
<div id="parallelizing-a-for-loop-with-dask.delayed" class="section level2">
<h2>Parallelizing a <code>for</code> loop with <code>dask.delayed()</code></h2>
<p><code>for</code> loops are one of the most common things that we want to parallelize. Use <code>dask.delayed</code>on <code>fun1</code> and <code>sum</code> to parallelize the computation below:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Make a simple list</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>data <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>]</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="op">%%</span>time</span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="co"># Loop element one by one</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co"># Sequential code</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>results <span class="op">=</span> []</span>
<span id="cb26-6"><a href="#cb26-6"></a></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="cf">for</span> i <span class="kw">in</span> data:</span>
<span id="cb26-8"><a href="#cb26-8"></a>    temp <span class="op">=</span> fun1(i)</span>
<span id="cb26-9"><a href="#cb26-9"></a>    results.append(temp)</span>
<span id="cb26-10"><a href="#cb26-10"></a></span>
<span id="cb26-11"><a href="#cb26-11"></a>total <span class="op">=</span> <span class="bu">sum</span>(results)</span></code></pre></div>
<p>A parallel version with <code>dask.delayed()</code> would be:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a><span class="op">%%</span>time</span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co"># Parallel code </span></span>
<span id="cb27-4"><a href="#cb27-4"></a>results <span class="op">=</span> []</span>
<span id="cb27-5"><a href="#cb27-5"></a></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="cf">for</span> i <span class="kw">in</span> data:</span>
<span id="cb27-7"><a href="#cb27-7"></a>    temp <span class="op">=</span> delayed(fun1)(i)</span>
<span id="cb27-8"><a href="#cb27-8"></a>    results.append(temp)</span>
<span id="cb27-9"><a href="#cb27-9"></a>    </span>
<span id="cb27-10"><a href="#cb27-10"></a>total <span class="op">=</span> delayed(<span class="bu">sum</span>)(results)</span>
<span id="cb27-11"><a href="#cb27-11"></a></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="co"># Let&#39;s see what type of thing total is</span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="bu">print</span>(<span class="st">&quot;Before computing:&quot;</span>, total)</span>
<span id="cb27-14"><a href="#cb27-14"></a></span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="co"># Compute</span></span>
<span id="cb27-16"><a href="#cb27-16"></a>result <span class="op">=</span> total.compute()</span>
<span id="cb27-17"><a href="#cb27-17"></a></span>
<span id="cb27-18"><a href="#cb27-18"></a><span class="co"># After it&#39;s computed</span></span>
<span id="cb27-19"><a href="#cb27-19"></a><span class="bu">print</span>(<span class="st">&quot;After computing :&quot;</span>, result)  </span></code></pre></div>
<p>Visualize the task graph for this:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># Look at the task graph for total</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>total.visualize()</span></code></pre></div>
<p>Now enlarge <code>data</code> to a larger list, e.g, <code>[1, 2, 3, 4, 5, 6, 7, 8]</code>. Check what would happen to the running time of <code>total</code>? Can you figure out why?</p>
</div>
<div id="combing-dask-and-xarray" class="section level2">
<h2>Combing <code>dask</code> and <code>xarray</code></h2>
<p><code>Xarray</code> can automatically wrap its data in <a href="https://tutorial.dask.org/03_array.html"><code>dask</code> arrays</a>. This capability turns <code>xarray</code> into an extremely powerful tool for Big Data earth science.</p>
<p>To illustrate this in action, we will use a fairly large dataset to analyze. This file contains <code>1</code> year of daily data from the <a href="https://www.aviso.altimetry.fr/en/home.html">AVISO</a> sea-surface height satellite altimetry dataset.</p>
<p>Let’s load the first file as a regular <code>xarray</code> dataset:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># Load the first file with xarray</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>ds_first <span class="op">=</span> xr.open_dataset(<span class="st">&#39;aviso_2015/dt_global_allsat_madt_h_20150101_20150914.nc&#39;</span>)</span>
<span id="cb29-3"><a href="#cb29-3"></a></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co"># Check the data</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>ds_first</span></code></pre></div>
<p>This one file is about <code>8 MB</code>. So <code>365</code> of them will be nearly <code>3 GB</code>. If we had downloaded all <code>25</code> years of data, it would be <code>73 GB</code>!. This is a good example of “medium data”.</p>
<p>With <a href="http://xarray.pydata.org/en/stable/generated/xarray.open_mfdataset.html"><code>open_mfdataset</code></a>, we can easily open all the netcdf files into one Dataset object.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># Use open_mfdataset to load all the nc files</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>ds <span class="op">=</span> xr.open_mfdataset(<span class="st">&#39;aviso_2015/*.nc&#39;</span>)</span>
<span id="cb30-3"><a href="#cb30-3"></a></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="co"># Check data object</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="co"># Notice that the values are not displayed</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>ds</span></code></pre></div>
<p>Note that the values are not displayed, since that would trigger computation.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="co"># Get sea surface height</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>ssh <span class="op">=</span> ds.adt</span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co"># Check the data, this is a dask array</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>ssh</span></code></pre></div>
<p>Try the following code, see what happens:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># Compute annual mean ssh</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>ssh_2015_mean <span class="op">=</span> ssh.mean(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span></code></pre></div>
<p>To actually compute the data:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># Compute annual mean ssh</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>ssh_2015_mean.load()</span>
<span id="cb33-3"><a href="#cb33-3"></a></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="co"># Plot annual mean</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>ssh_2015_mean.plot()</span></code></pre></div>
<p>Finally, close the client (local cluster):</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># Close the client (local cluster)</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>my_client.close()</span></code></pre></div>
<hr />
</div>
</div>
<div id="python-next" class="section level1">
<h1><code>Python</code> next?</h1>
<p>So far we have covered the basics of <code>Python</code> and fundamental modules to make plots and analyze data. Looking forward, the learning curve is still steep, be patient as it takes time. Use Google and <a href="https://stackoverflow.com/">stackoverflow</a> without hesitation, as you will find 9 out 10 times your questions/issues have been reported and solved (luckily) already. Have fun!</p>
<hr />
<p><em>The notes are modified from the excellent <a href="https://rabernat.github.io/research_computing_2018/dask-for-parallel-computing-and-big-data.html">Dask for Parallel Computing and Big Data</a>, <a href="https://rabernat.github.io/research_computing_2018/python-environments.html">Python Environments</a>, and <a href="https://towardsdatascience.com/getting-started-with-python-environments-using-conda-32e9f2779307">Getting started with Python environments (using Conda)</a>, all available freely online.</em></p>
<hr />
</div>
<div id="in-class-exercises" class="section level1">
<h1>In-class exercises</h1>
<div id="exercise-1" class="section level2">
<h2>Exercise #1</h2>
<p><strong>1.1</strong> Create a <code>conda</code> environment called <code>test</code> with <code>Python 3.6</code> installed.</p>
<p><strong>1.2</strong> Install a module under the <code>test</code> environment.</p>
<p><strong>1.3</strong> Export <code>test</code> environment configuration to an environment file, and share it with your deskmate.</p>
<p><strong>1.4</strong> Create a new <code>conda</code> environment called <code>test_mate</code> using your deskmate’s environment file.</p>
<p><strong>1.5</strong> Activate the <code>test_mate</code> environment, and verify it contains the module your deskmate specified in his/her environment file.</p>
<p><strong>1.6</strong> Deactivate both <code>test</code> and <code>test_mate</code> environments.</p>
<p><strong>1.7</strong> Remove both <code>test</code> and <code>test_mate</code> environments, along with modules installed.</p>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise #2</h2>
<p>Compute and plot the variance in daily <code>ssh</code> anomalies with <code>dask</code>.</p>
<hr />
</div>
</div>
<div id="further-reading" class="section level1">
<h1>Further reading</h1>
<ul>
<li><a href="https://conda.io/projects/conda/en/latest/_downloads/843d9e0198f2a193a3484886fa28163c/conda-cheatsheet.pdf">Conda Cheat sheet</a></li>
<li><a href="https://carpentries-incubator.github.io/introduction-to-conda-for-data-scientists/04-sharing-environments/index.html">Sharing Environments</a></li>
<li><a href="https://conda.io/projects/conda/en/latest/user-guide/getting-started.html">Getting started with conda</a></li>
<li><a href="https://github.com/dask/dask-tutorial"><code>Dask</code> tutorial</a></li>
<li><a href="https://saturncloud.io/blog/a-data-scientist-s-guide-to-lazy-evaluation-with-dask/">A Data Scientist’s Guide to Lazy Evaluation with <code>Dask</code></a></li>
<li><a href="https://book.pythontips.com/en/latest/">Intermediate Python</a></li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
